<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTLãŠã¿ã‚„ã’é…å¸ƒâ­ï¸ã‚ã¿ã ãã˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap');
        
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #fff0f5; /* è–„ã„ãƒ”ãƒ³ã‚¯ */
            background-image: radial-gradient(#fbcfe8 2px, transparent 2px);
            background-size: 20px 20px;
            color: #5c4b51;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #f9a8d4;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(249, 168, 212, 0.3);
            overflow: hidden;
            /* é«˜ã•ã¯JSã§canvasã«åˆã‚ã›ã¦èª¿æ•´ã•ã‚Œã‚‹ãŸã‚å›ºå®šã—ãªã„ */
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        canvas {
            cursor: pointer;
            touch-action: none;
            display: block;
            width: 100%; /* ã‚³ãƒ³ãƒ†ãƒŠå¹…ã«åˆã‚ã›ã‚‹ */
            height: auto; /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦é«˜ã•è‡ªå‹•èª¿æ•´ */
            max-width: 100%;
        }

        /* ã·ã‚‹ã‚“ã¨ã—ãŸãƒœã‚¿ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .btn-pop {
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .btn-pop:active {
            transform: scale(0.95);
        }
        .btn-pop:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #fff0f5;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #f9a8d4;
            border-radius: 4px;
        }
        
        .modal-overlay {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4">

    <header class="mb-8 text-center animate-fade-in">
        <h1 class="text-3xl md:text-5xl font-black text-pink-500 mb-2 drop-shadow-sm tracking-wide">
            <i class="fas fa-star text-yellow-400 mr-2 rotate-12"></i>FTLãŠã¿ã‚„ã’é…å¸ƒâ­ï¸ã‚ã¿ã ãã˜<i class="fas fa-heart text-red-400 ml-2 -rotate-12"></i>
        </h1>
        <p class="text-gray-500 font-bold bg-white/80 inline-block px-4 py-1 rounded-full shadow-sm text-sm md:text-base">
            ãƒ‰ã‚­ãƒ‰ã‚­ï¼ä½•ãŒå½“ãŸã‚‹ã‹ãªï¼Ÿ
        </p>
    </header>

    <main class="w-full max-w-4xl space-y-8 relative">
        
        <!-- è¨­å®šã‚¨ãƒªã‚¢ -->
        <div id="setup-panel" class="bg-white/90 backdrop-blur-sm p-4 md:p-8 rounded-[2rem] shadow-xl border-4 border-pink-200 animate-fade-in">
            
            <!-- ä¸Šæ®µï¼šäººæ•°è¨­å®š -->
            <div class="flex flex-col items-center justify-center mb-8 pb-6 border-b-2 border-dashed border-pink-200">
                <label class="font-bold text-xl text-gray-600 mb-4 flex items-center">
                    <span class="bg-blue-100 text-blue-500 rounded-full w-8 h-8 flex items-center justify-center mr-2"><i class="fas fa-users"></i></span>
                    å‚åŠ äººæ•°ã‚’æ±ºã‚ã¦ã­
                </label>
                <div class="flex items-center bg-pink-50 rounded-2xl p-2 shadow-inner gap-4 border-2 border-pink-100">
                    <button onclick="changeCount(-1)" class="btn-pop w-12 h-12 rounded-xl bg-white text-pink-500 font-black text-2xl shadow-sm border border-pink-100 flex-shrink-0">-</button>
                    <input type="number" id="count-input" value="4" min="2" max="100" onchange="updateCountFromInput()" class="w-24 text-center font-black text-4xl text-gray-700 bg-transparent focus:outline-none focus:bg-white rounded-lg p-1">
                    <button onclick="changeCount(1)" class="btn-pop w-12 h-12 rounded-xl bg-white text-pink-500 font-black text-2xl shadow-sm border border-pink-100 flex-shrink-0">+</button>
                </div>
                <p class="text-xs text-gray-400 mt-2">â€»ç”»é¢ã«åˆã‚ã›ã¦ç¸®å°è¡¨ç¤ºã•ã‚Œã¾ã™</p>
            </div>

            <!-- ä¸­æ®µï¼šå•†å“è¨­å®š -->
            <div class="bg-yellow-50 p-6 rounded-[1.5rem] mb-8 border-2 border-yellow-200 relative">
                <div class="absolute -top-4 left-6 bg-yellow-400 text-white font-bold px-4 py-1 rounded-full text-sm shadow-md transform -rotate-2">
                    <i class="fas fa-gift mr-1"></i> å•†å“ãƒªã‚¹ãƒˆ
                </div>

                <div class="flex flex-wrap gap-3 mb-4 items-end mt-2">
                    <div class="flex-1 min-w-[140px]">
                        <label class="text-xs text-yellow-700 font-bold ml-2">ãªã«ãŒå½“ãŸã‚‹ï¼Ÿ</label>
                        <input type="text" id="bulk-name" placeholder="ä¾‹: ğŸ° ã‚±ãƒ¼ã‚­" class="w-full border-2 border-yellow-200 rounded-2xl px-4 py-3 focus:outline-none focus:border-yellow-400 focus:ring-4 focus:ring-yellow-100 bg-white font-bold text-gray-700 placeholder-yellow-200 transition-all">
                    </div>
                    <div class="w-24">
                        <label class="text-xs text-yellow-700 font-bold ml-2">ã„ãã¤ï¼Ÿ</label>
                        <input type="number" id="bulk-count" value="1" min="1" class="w-full border-2 border-yellow-200 rounded-2xl px-3 py-3 focus:outline-none focus:border-yellow-400 focus:ring-4 focus:ring-yellow-100 text-center bg-white font-bold text-gray-700">
                    </div>
                    <button onclick="addBulkItem()" class="btn-pop bg-yellow-400 text-white font-bold px-6 py-3 rounded-2xl shadow-md h-[52px] border-b-4 border-yellow-500 active:border-b-0 active:translate-y-1">
                        <i class="fas fa-plus"></i> è¿½åŠ 
                    </button>
                </div>

                <div class="bg-white rounded-2xl p-4 shadow-inner border border-yellow-100 min-h-[100px] max-h-[300px] overflow-y-auto custom-scrollbar">
                    <ul id="bulk-list" class="space-y-2">
                        <li class="text-gray-300 text-center py-6 flex flex-col items-center font-bold">
                            <i class="fas fa-magic mb-2 text-yellow-200 text-3xl"></i>
                            <span>ã“ã“ã«å•†å“ã‚’è¿½åŠ ã—ã¦ã­ï¼</span>
                        </li>
                    </ul>
                </div>
                
                <p class="text-right text-xs text-yellow-600 font-bold mt-2 mr-2">
                    â€»å…¥åŠ›ãŒäººæ•°ã‚ˆã‚Šå°‘ãªã„åˆ†ã¯ã€Œâ˜…ã€ã«ãªã‚Šã¾ã™
                </p>
            </div>

            <!-- ä½œæˆãƒœã‚¿ãƒ³ -->
            <div class="text-center">
                <button onclick="generateAmida()" class="btn-pop w-full md:w-2/3 px-12 py-5 bg-gradient-to-r from-pink-400 to-rose-400 text-white text-xl rounded-full font-black shadow-lg shadow-pink-200 border-b-4 border-rose-500 active:border-b-0 active:translate-y-1 flex items-center justify-center mx-auto tracking-wider">
                    <i class="fas fa-wand-magic-sparkles mr-2"></i> ã‚¹ã‚¿ãƒ¼ãƒˆï¼
                </button>
            </div>
        </div>

        <!-- ã‚ã¿ã ãã˜è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="game-panel" class="hidden space-y-6 animate-fade-in pb-20">
            
            <div class="flex flex-wrap justify-between items-center bg-white/80 backdrop-blur p-4 rounded-2xl shadow-sm border-2 border-pink-100 gap-3">
                <button onclick="resetView()" class="text-pink-400 hover:text-pink-600 font-bold px-3 py-1 btn-pop">
                    <i class="fas fa-chevron-left mr-1"></i> ã‚‚ã©ã‚‹
                </button>
                <div class="flex gap-3">
                     <button onclick="resetPaths()" class="px-5 py-2 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition btn-pop text-sm">
                        <i class="fas fa-undo mr-1"></i> ã‚‚ã†ä¸€å›
                    </button>
                    <button onclick="revealAll()" class="px-5 py-2 bg-blue-400 text-white rounded-xl font-bold hover:bg-blue-500 transition shadow-md shadow-blue-200 btn-pop text-sm">
                        <i class="fas fa-eye mr-1"></i> å…¨éƒ¨ã¿ã‚‹
                    </button>
                </div>
            </div>

            <!-- å•†å“ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—è¡¨ç¤º -->
            <div id="prize-lineup" class="bg-yellow-100 border-2 border-yellow-300 p-4 rounded-2xl text-center shadow-sm relative overflow-hidden">
                <i class="fas fa-gift absolute -right-4 -bottom-4 text-6xl text-yellow-200/50 rotate-12"></i>
                <div class="relative z-10">
                    <span class="font-black text-yellow-700 mr-2 bg-white px-3 py-1 rounded-full text-sm inline-block mb-1">ä»Šå›ã®ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—</span>
                    <div id="lineup-text" class="text-gray-700 font-bold mt-1 text-lg"></div>
                </div>
            </div>

            <!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ -->
            <div class="canvas-container">
                <!-- ã‚­ãƒ£ãƒ³ãƒã‚¹è‡ªä½“ã¯style="width:100%"ã§ç¸®å°è¡¨ç¤ºã•ã‚Œã‚‹ -->
                <canvas id="amidaCanvas"></canvas>
            </div>

            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="result-message" class="hidden bg-white p-6 rounded-[2rem] shadow-xl border-4 border-pink-300 animate-fade-in text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pink-300 via-yellow-300 to-blue-300"></div>
                <p id="result-text" class="text-xl text-gray-700 font-bold relative z-10"></p>
            </div>
        </div>

        <!-- çµæœä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="summary-modal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4 animate-fade-in">
            <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl border-4 border-pink-200 relative max-h-[90vh] flex flex-col">
                <div class="p-6 text-center border-b-2 border-dashed border-pink-100">
                    <h2 class="text-3xl font-black text-pink-500">
                        <i class="fas fa-crown text-yellow-400 mr-2"></i>çµæœç™ºè¡¨
                    </h2>
                    <p class="text-gray-400 font-bold text-sm mt-1">ã¿ã‚“ãªã®çµæœãŒå‡ºæƒã„ã¾ã—ãŸï¼</p>
                </div>
                <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                    <ul id="summary-list" class="space-y-3"></ul>
                </div>
                <div class="p-6 text-center bg-pink-50 rounded-b-[2rem]">
                    <button onclick="closeSummary()" class="btn-pop bg-pink-400 text-white font-bold px-8 py-3 rounded-full shadow-lg border-b-4 border-pink-500 active:border-b-0 active:translate-y-1">
                        é–‰ã˜ã‚‹
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script>
        const MIN_COUNT = 2;
        const MAX_COUNT = 100; 
        let currentCount = 4;
        
        let names = []; 
        let results = [];
        let horizontalLines = []; 
        let bulkItems = [];

        const canvas = document.getElementById('amidaCanvas');
        const ctx = canvas.getContext('2d');
        
        // å†…éƒ¨è§£åƒåº¦ç”¨ã®å¤‰æ•°
        let logicalWidth, logicalHeight;
        const COL_WIDTH = 60; // 1åˆ—ã‚ãŸã‚Šã®ç†æƒ³å¹…
        const MIN_LOGICAL_WIDTH = 300;
        const HEADER_HEIGHT = 80;
        const FOOTER_HEIGHT = 100; // çµæœãŒè¦‹åˆ‡ã‚Œãªã„ã‚ˆã†ã«ååˆ†ç¢ºä¿
        const PADDING_SIDE = 40;
        
        const colors = [
            '#ff99c8', '#fcf6bd', '#d0f4de', '#a9def9', '#e4c1f9', 
            '#ffadad', '#ffd6a5', '#fdffb6', '#caffbf', '#9bf6ff'
        ];
        const lineColors = [
            '#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', 
            '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#f43f5e'
        ];

        let paths = []; 
        let isAnimating = false;
        let revealed = new Array(MAX_COUNT).fill(false); 
        let revealedResults = new Array(MAX_COUNT).fill(false); 

        function init() {
            updateDisplays();
            updateBulkList();
        }

        function updateDisplays() {
            document.getElementById('count-input').value = currentCount;
        }
        
        function changeCount(delta) {
            const newCount = currentCount + delta;
            if (newCount >= MIN_COUNT && newCount <= MAX_COUNT) {
                currentCount = newCount;
                updateDisplays();
            }
        }
        
        function updateCountFromInput() {
            const val = parseInt(document.getElementById('count-input').value);
            if (!isNaN(val) && val >= MIN_COUNT && val <= MAX_COUNT) {
                currentCount = val;
            } else {
                updateDisplays();
            }
        }

        function addBulkItem() {
            const nameInput = document.getElementById('bulk-name');
            const countInput = document.getElementById('bulk-count');
            const name = nameInput.value.trim();
            const count = parseInt(countInput.value);
            if (!name || count < 1) return;
            bulkItems.push({ name, count });
            nameInput.value = '';
            countInput.value = 1;
            nameInput.focus();
            updateBulkList();
        }

        function removeBulkItem(index) {
            bulkItems.splice(index, 1);
            updateBulkList();
        }

        function updateBulkList() {
            const listEl = document.getElementById('bulk-list');
            listEl.innerHTML = '';
            if (bulkItems.length === 0) {
                listEl.innerHTML = `<li class="text-gray-300 text-center py-6 flex flex-col items-center font-bold"><i class="fas fa-magic mb-2 text-yellow-200 text-3xl"></i><span>ã“ã“ã«å•†å“ã‚’è¿½åŠ ã—ã¦ã­ï¼</span></li>`;
                return;
            }
            bulkItems.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-yellow-50 px-4 py-3 rounded-xl border border-yellow-200 shadow-sm animate-fade-in';
                li.innerHTML = `<div class="flex items-center gap-3"><span class="w-10 h-10 rounded-full bg-white border-2 border-yellow-200 flex items-center justify-center text-yellow-500 font-bold text-lg shadow-sm"><i class="fas fa-gift"></i></span><span class="font-bold text-gray-700 text-lg">${item.name}</span><span class="text-yellow-600 text-xs font-bold bg-yellow-100 px-3 py-1 rounded-full border border-yellow-200">Ã— ${item.count}</span></div><button onclick="removeBulkItem(${index})" class="text-red-400 hover:text-red-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition"><i class="fas fa-times"></i></button>`;
                listEl.appendChild(li);
            });
        }

        function generateAmida() {
            results = [];
            bulkItems.forEach(item => {
                for(let i=0; i<item.count; i++) results.push(item.name);
            });
            const currentLen = results.length;
            if (currentLen < currentCount) {
                for(let i=currentLen; i<currentCount; i++) results.push("â˜…");
            } else if (currentLen > currentCount) {
                results.sort(() => 0.5 - Math.random());
                results = results.slice(0, currentCount);
            }
            results.sort(() => 0.5 - Math.random());
            
            const summary = {};
            let hasItem = false;
            results.forEach(r => { if (r !== "â˜…") { summary[r] = (summary[r] || 0) + 1; hasItem = true; } });
            const summaryText = !hasItem ? "ï¼ˆå•†å“ãªã—...ï¼Ÿï¼‰" : Object.entries(summary).map(([n, c]) => `${n}Ã—${c}`).join(' / ');
            document.getElementById('lineup-text').textContent = summaryText;

            names = [];
            for(let i=0; i<currentCount; i++) names[i] = `${i+1}`;

            horizontalLines = [];
            const segments = Math.max(12, Math.floor(currentCount * 0.8)); 
            for (let s = 0; s < segments; s++) {
                const gaps = currentCount - 1;
                let candidates = [];
                for(let g=0; g<gaps; g++) candidates.push(g);
                candidates.sort(() => 0.5 - Math.random());
                let used = new Array(gaps).fill(false);
                for(let g of candidates) {
                    if(used[g]) continue;
                    if(g > 0 && used[g-1]) continue;
                    if(g < gaps-1 && used[g+1]) continue;
                    if(Math.random() > 0.3) {
                        const segmentHeight = 0.8 / segments;
                        const baseY = 0.1 + (s * segmentHeight);
                        horizontalLines.push({ col: g, y: baseY + (Math.random() * 0.02) });
                        used[g] = true;
                    }
                }
            }
            horizontalLines.sort((a, b) => a.y - b.y);

            document.getElementById('setup-panel').classList.add('hidden');
            document.getElementById('game-panel').classList.remove('hidden');
            document.querySelector('header').classList.add('hidden'); 
            
            revealed = new Array(currentCount).fill(false);
            revealedResults = new Array(currentCount).fill(false);
            paths = [];
            isAnimating = false;
            document.getElementById('result-message').classList.add('hidden');
            closeSummary();

            setTimeout(resizeCanvas, 50);
        }

        function resetView() {
            document.getElementById('game-panel').classList.add('hidden');
            document.getElementById('setup-panel').classList.remove('hidden');
            document.querySelector('header').classList.remove('hidden');
            closeSummary();
        }

        function resetPaths() {
            if(isAnimating) return;
            revealed = new Array(currentCount).fill(false);
            revealedResults = new Array(currentCount).fill(false);
            paths = [];
            document.getElementById('result-message').classList.add('hidden');
            closeSummary();
            drawBoard();
        }

        // --- æç”»ãƒ»ãƒªã‚µã‚¤ã‚ºå‡¦ç†ï¼ˆæ ¸å¿ƒéƒ¨åˆ†ï¼‰ ---

        function resizeCanvas() {
            const container = document.querySelector('.canvas-container');
            
            // 1. å¿…è¦ãªã€Œè«–ç†çš„ãªå¹…ã€ã‚’è¨ˆç®— (äººæ•° * 1åˆ—å¹… + ä½™ç™½)
            // äººæ•°ãŒå¤šãã¦ã‚‚1åˆ—60pxã¯ç¢ºä¿ã—ã¦æç”»ã™ã‚‹ï¼ˆæ–‡å­—ãŒæ½°ã‚Œãªã„ã‚ˆã†ã«ï¼‰
            logicalWidth = Math.max(MIN_LOGICAL_WIDTH, (currentCount * COL_WIDTH) + (PADDING_SIDE * 2));
            
            // 2. é«˜ã•ã¯ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’è€ƒæ…®ã—ã¦é©å½“ã«æ±ºã‚ã‚‹ï¼ˆã¾ãŸã¯å›ºå®šï¼‰
            // æ¨ªã«é•·ã„å ´åˆã¯é«˜ã•ã‚‚ã‚ã‚‹ç¨‹åº¦ç¢ºä¿ã—ãªã„ã¨ç·šãŒè©°ã¾ã‚Šã™ãã‚‹
            // é€†ã«ç¸¦é•·ã™ãã¦ã‚‚è¦‹ã«ãã„ã®ã§ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹
            logicalHeight = Math.max(600, logicalWidth * 0.6); 
            // ãŸã ã—é«˜ã™ãã‚‹ã¨ã‚¹ãƒãƒ›ã§ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãŒå¿…è¦ã«ãªã‚‹ã®ã§ä¸Šé™ã‚­ãƒ£ãƒƒãƒ—ã‚‚è€ƒæ…®ã—ãŸã„ãŒã€
            // ã€Œå…¨ä½“ã‚’è¡¨ç¤ºã€ãŒå„ªå…ˆãªã®ã§ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å„ªå…ˆã€‚
            
            // 3. ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è§£åƒåº¦ã‚’è¨­å®šï¼ˆã“ã‚ŒãŒæç”»ã•ã‚Œã‚‹ãƒ”ã‚¯ã‚»ãƒ«æ•°ï¼‰
            // Retinaå¯¾å¿œã¯å¾Œã§è¡Œã†ãŒã€ã¾ãšã¯è«–ç†ã‚µã‚¤ã‚º
            const dpr = window.devicePixelRatio || 1;
            canvas.width = logicalWidth * dpr;
            canvas.height = logicalHeight * dpr;
            
            // 4. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´
            ctx.resetTransform();
            ctx.scale(dpr, dpr);

            drawBoard();
        }

        function getColX(index) {
            // è«–ç†å¹…ã®ä¸­ã§ã®Xåº§æ¨™
            const usableWidth = logicalWidth - (PADDING_SIDE * 2);
            const spacing = usableWidth / Math.max(1, currentCount - 1);
            return PADDING_SIDE + index * spacing;
        }

        function drawBoard() {
            ctx.clearRect(0, 0, logicalWidth, logicalHeight);
            
            const lineTop = HEADER_HEIGHT;
            const lineBottom = logicalHeight - FOOTER_HEIGHT;
            const lineHeight = lineBottom - lineTop;

            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const colSpacing = (logicalWidth - (PADDING_SIDE * 2)) / Math.max(1, currentCount - 1);
            
            // è¦ç´ ã‚µã‚¤ã‚ºï¼ˆè«–ç†åº§æ¨™ç³»ãªã®ã§ã€äººæ•°ãŒå¤šãã¦ã‚‚å°ã•ããªã‚Šã™ããªã„ï¼‰
            const baseSize = Math.min(48, colSpacing * 0.8);
            const radius = baseSize / 2;
            const fontSize = Math.max(12, radius * 0.8); // æœ€å°ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºç¢ºä¿

            for (let i = 0; i < currentCount; i++) {
                const x = getColX(i);
                const colorIdx = i % colors.length;
                const bgColor = colors[colorIdx];
                const lineColor = lineColors[colorIdx];
                
                // åå‰ (ä¸Š)
                ctx.beginPath();
                ctx.arc(x, HEADER_HEIGHT / 2, radius, 0, Math.PI * 2);
                ctx.fillStyle = revealed[i] ? '#e5e7eb' : bgColor;
                ctx.fill();
                ctx.lineWidth = 3;
                ctx.strokeStyle = revealed[i] ? '#d1d5db' : '#fff';
                ctx.stroke();
                
                ctx.fillStyle = revealed[i] ? '#9ca3af' : '#78350f'; 
                ctx.font = `bold ${fontSize}px "M PLUS Rounded 1c"`;
                ctx.fillText(`${i+1}`, x, HEADER_HEIGHT / 2);
                
                // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹
                ctx.beginPath();
                ctx.arc(x, lineTop, 4, 0, Math.PI * 2);
                ctx.fillStyle = revealed[i] ? '#d1d5db' : lineColor;
                ctx.fill();

                // çµæœ (ä¸‹)
                const isRevealed = revealedResults[i];
                if (isRevealed) {
                    ctx.fillStyle = '#fff';
                    ctx.shadowColor = "rgba(0,0,0,0.1)";
                    ctx.shadowBlur = 4;
                    ctx.shadowOffsetY = 2;
                } else {
                    ctx.fillStyle = '#fce7f3';
                    ctx.shadowColor = "transparent";
                }
                
                ctx.strokeStyle = isRevealed ? '#f9a8d4' : '#fbcfe8';
                ctx.lineWidth = 2;
                
                const boxW = Math.max(40, colSpacing * 0.9); // å¹…ç¢ºä¿
                const boxH = FOOTER_HEIGHT - 20;
                const boxY = lineBottom + 10;
                
                ctx.beginPath();
                ctx.roundRect(x - boxW/2, boxY, boxW, boxH, 8);
                ctx.fill();
                ctx.shadowColor = "transparent"; 
                ctx.stroke();

                if (isRevealed) {
                    ctx.fillStyle = '#db2777'; 
                    const result = results[i];
                    let resFontSize = Math.min(16, boxW / 4); // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´
                    ctx.font = `bold ${resFontSize}px "M PLUS Rounded 1c"`;
                    
                    // ç¸¦æ›¸ãã£ã½ãè¡¨ç¤º (ç°¡æ˜“)
                    // å¹…ãŒç‹­ã„ã¨ãã¯1æ–‡å­—ãšã¤æ”¹è¡Œã™ã‚‹ãªã©å·¥å¤«ãŒå¿…è¦ã ãŒã€
                    // ä»Šå›ã¯æ¨ªæ›¸ãã§çœç•¥è¡¨ç¤º
                    const maxChars = Math.floor(boxW / resFontSize);
                    const displayResult = result.length > maxChars ? result.substring(0, maxChars) + '.' : result;
                    ctx.fillText(displayResult, x, boxY + boxH/2);
                } else {
                    ctx.fillStyle = '#f472b6';
                    ctx.font = `bold ${Math.min(24, boxW/2)}px "M PLUS Rounded 1c"`;
                    ctx.fillText("?", x, boxY + boxH/2);
                }
            }

            // ç¸¦ç·š
            ctx.lineWidth = 4;
            ctx.strokeStyle = '#fce7f3'; 
            for (let i = 0; i < currentCount; i++) {
                const x = getColX(i);
                ctx.beginPath();
                ctx.moveTo(x, lineTop);
                ctx.lineTo(x, lineBottom);
                ctx.stroke();
            }

            // æ¨ªç·š
            for (let line of horizontalLines) {
                const x1 = getColX(line.col);
                const x2 = getColX(line.col + 1);
                const y = lineTop + (line.y * lineHeight);

                ctx.beginPath();
                ctx.moveTo(x1, y);
                ctx.lineTo(x2, y);
                ctx.stroke();
            }

            // ãƒ‘ã‚¹
            paths.forEach(p => {
                drawPathLine(p.coords, lineColors[p.startIndex % lineColors.length]);
            });
        }

        function calculatePath(startIndex) {
            let col = startIndex;
            let currentY = 0;
            const coords = [];
            const lineTop = HEADER_HEIGHT;
            const lineBottom = logicalHeight - FOOTER_HEIGHT;
            const lineHeight = lineBottom - lineTop;

            coords.push({ x: getColX(col), y: lineTop });

            for (let i = 0; i < horizontalLines.length; i++) {
                const line = horizontalLines[i];
                if (line.y > currentY) {
                    if (line.col === col - 1) {
                        const yPixel = lineTop + (line.y * lineHeight);
                        coords.push({ x: getColX(col), y: yPixel });
                        col = col - 1;
                        coords.push({ x: getColX(col), y: yPixel });
                        currentY = line.y;
                    }
                    else if (line.col === col) {
                        const yPixel = lineTop + (line.y * lineHeight);
                        coords.push({ x: getColX(col), y: yPixel });
                        col = col + 1;
                        coords.push({ x: getColX(col), y: yPixel });
                        currentY = line.y;
                    }
                }
            }
            coords.push({ x: getColX(col), y: lineBottom });
            return { startIndex, endIndex: col, coords };
        }

        function drawPathLine(coords, color) {
            ctx.lineWidth = 5; // å¤ªãè¦‹ã‚„ã™ã
            ctx.strokeStyle = color;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.shadowBlur = 0;
            ctx.beginPath();
            if(coords.length > 0) ctx.moveTo(coords[0].x, coords[0].y);
            for (let i = 1; i < coords.length; i++) ctx.lineTo(coords[i].x, coords[i].y);
            ctx.stroke();
        }

        function animateSinglePath(pathData, onComplete) {
            isAnimating = true;
            let totalLength = 0;
            const segments = [];
            for(let i=0; i<pathData.coords.length-1; i++) {
                const dx = pathData.coords[i+1].x - pathData.coords[i].x;
                const dy = pathData.coords[i+1].y - pathData.coords[i].y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                segments.push({ start: pathData.coords[i], end: pathData.coords[i+1], length: dist });
                totalLength += dist;
            }

            let currentDist = 0;
            const duration = 3000; 
            const startTime = performance.now();
            const color = lineColors[pathData.startIndex % lineColors.length];
            
            function loop(now) {
                const elapsed = now - startTime;
                currentDist = (elapsed / duration) * totalLength;
                if(currentDist > totalLength) currentDist = totalLength;

                drawBoard(); 
                
                ctx.lineWidth = 6; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã¯ã•ã‚‰ã«å¤ªã
                ctx.strokeStyle = color;
                ctx.shadowBlur = 10; // ç™ºå…‰è¡¨ç¾
                ctx.shadowColor = color;
                ctx.beginPath();
                ctx.moveTo(segments[0].start.x, segments[0].start.y);

                let distRem = currentDist;
                for(let seg of segments) {
                    if(distRem <= 0) break;
                    if(distRem >= seg.length) {
                        ctx.lineTo(seg.end.x, seg.end.y);
                        distRem -= seg.length;
                    } else {
                        const ratio = distRem / seg.length;
                        const mx = seg.start.x + (seg.end.x - seg.start.x) * ratio;
                        const my = seg.start.y + (seg.end.y - seg.start.y) * ratio;
                        ctx.lineTo(mx, my);
                        distRem = 0;
                    }
                }
                ctx.stroke();
                ctx.shadowBlur = 0;

                if (currentDist < totalLength) {
                    requestAnimationFrame(loop);
                } else {
                    isAnimating = false;
                    paths.push(pathData);
                    revealedResults[pathData.endIndex] = true;
                    drawBoard();
                    showResult(pathData);
                    checkAllRevealed();
                    if(onComplete) onComplete();
                }
            }
            requestAnimationFrame(loop);
        }

        function showResult(pathData) {
            const startName = names[pathData.startIndex];
            const endResult = results[pathData.endIndex];
            const msgBox = document.getElementById('result-message');
            const msgText = document.getElementById('result-text');
            msgText.innerHTML = `<div class="mb-2 text-pink-400 text-sm font-bold">ğŸ‰ çµæœç™ºè¡¨ ğŸ‰</div><div class="text-xl mb-3"><span class="font-black text-blue-500 text-3xl">${startName}</span>ç•ª ã¯...</div><div class="text-4xl font-black text-pink-500 drop-shadow-sm animate-pulse">${endResult}</div>`;
            msgBox.classList.remove('hidden');
            msgBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function checkAllRevealed() {
            if (revealed.every(r => r === true)) {
                setTimeout(() => showSummary(), 1500);
            }
        }

        function showSummary() {
            const modal = document.getElementById('summary-modal');
            const list = document.getElementById('summary-list');
            list.innerHTML = '';
            for (let i = 0; i < currentCount; i++) {
                const pathData = calculatePath(i);
                const result = results[pathData.endIndex];
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-3 bg-pink-50 rounded-xl border border-pink-100';
                li.innerHTML = `<div class="flex items-center gap-3"><span class="w-8 h-8 rounded-full bg-white border border-pink-200 flex items-center justify-center font-black text-pink-500 shadow-sm">${i+1}</span><span class="text-gray-400 text-sm">â”</span><span class="font-bold text-gray-700 text-lg">${result}</span></div>`;
                list.appendChild(li);
            }
            modal.classList.remove('hidden');
        }

        function closeSummary() {
            document.getElementById('summary-modal').classList.add('hidden');
        }

        // ã‚¯ãƒªãƒƒã‚¯åˆ¤å®š: CSSã®ç¸®å°ã‚’è€ƒæ…®ã—ã¦åº§æ¨™å¤‰æ›ãŒå¿…è¦
        canvas.addEventListener('click', (e) => {
            if (isAnimating) return;
            
            // å®Ÿéš›ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã¨è«–ç†ã‚µã‚¤ã‚ºã®æ¯”ç‡ã‚’è¨ˆç®—
            const rect = canvas.getBoundingClientRect();
            const scaleX = logicalWidth / rect.width;
            const scaleY = logicalHeight / rect.height;

            // è«–ç†åº§æ¨™ç³»ã§ã®ã‚¯ãƒªãƒƒã‚¯ä½ç½®
            const clickX = (e.clientX - rect.left) * scaleX;
            const clickY = (e.clientY - rect.top) * scaleY;

            if (clickY < HEADER_HEIGHT + 40) {
                const spacing = (logicalWidth - PADDING_SIDE * 2) / Math.max(1, currentCount - 1);
                const threshold = Math.min(40, spacing / 2); // åˆ¤å®šç¯„å›²

                let clickedCol = -1;
                for(let i=0; i<currentCount; i++) {
                    const cx = getColX(i);
                    if (Math.abs(clickX - cx) < threshold) {
                        clickedCol = i;
                        break;
                    }
                }
                if (clickedCol !== -1 && !revealed[clickedCol]) {
                    revealed[clickedCol] = true;
                    drawBoard();
                    const pathData = calculatePath(clickedCol);
                    animateSinglePath(pathData);
                }
            }
        });

        async function revealAll() {
            if(isAnimating) return;
            const unrevealedIndices = [];
            for(let i=0; i<currentCount; i++) if(!revealed[i]) unrevealedIndices.push(i);
            
            if(unrevealedIndices.length === 0) { showSummary(); return; }

            for(let i of unrevealedIndices) {
                revealed[i] = true;
                const path = calculatePath(i);
                paths.push(path);
                revealedResults[path.endIndex] = true; 
            }
            drawBoard();
            const msgBox = document.getElementById('result-message');
            document.getElementById('result-text').textContent = "å…¨å“¡ã®çµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼";
            msgBox.classList.remove('hidden');
            msgBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            checkAllRevealed();
        }

        window.addEventListener('resize', () => {
            if(!document.getElementById('game-panel').classList.contains('hidden')) {
                // ãƒªã‚µã‚¤ã‚ºæ™‚ã¯å†è¨ˆç®—ã›ãšã«styleã®è‡ªå‹•èª¿æ•´ã«ä»»ã›ã‚‹ï¼ˆå†æç”»ã™ã‚‹ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒé£›ã¶ãŸã‚ï¼‰
                // ãŸã ã—æ¥µç«¯ãªå¤‰æ›´ã«å¯¾å¿œã™ã‚‹ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰æ¨å¥¨ã ãŒã€ã“ã“ã§ã¯ç°¡æ˜“çš„ã«å†æç”»
                // resizeCanvas(); 
            }
        });

        init();
    </script>
</body>
</html>
